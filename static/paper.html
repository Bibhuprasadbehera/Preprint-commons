<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Paper Details - Preprint Commons</title>
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="paper.css">
</head>
<body>
  <div id="navbar-container"></div>
  <div class="container paper-details-container">
    <div class="paper-main-content">
      <h1 id="paper-title"></h1>
      <p id="paper-authors" class="authors"></p>
      <div><h2>Abstract</h2><p id="paper-abstract"></p></div>
      <div><h2>Citation History</h2><div id="citation-chart"></div></div>
    </div>
    <div class="paper-metadata" id="metadata">
      <!-- Metadata will be filled by JS -->
    </div>
  </div>
  <div id="footer-container"></div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    fetch('navbar.html').then(r=>r.text()).then(d=>$('navbar-container').innerHTML=d);
    fetch('footer.html').then(r=>r.text()).then(d=>$('footer-container').innerHTML=d);

    const ppcId = new URLSearchParams(location.search).get('id');
    fetch(`/paper/${ppcId}`).then(r=>r.json()).then(data=>{
      $('paper-title').textContent = data.preprint_title;
      $('paper-authors').textContent = JSON.parse(data.all_authors).map(a=>a.author_name).join(', ');
      $('paper-abstract').textContent = data.preprint_abstract;
      const meta = [
        {k:'preprint_doi',l:'DOI',v: d=>`<a href="https://doi.org/${d}" target="_blank">${d}</a>`},
        {k:'preprint_submission_date',l:'Submission Date',v: d=>new Date(d).toLocaleDateString()},
        {k:'preprint_server',l:'Preprint Server'},
        {k:'submission_contact',l:'Submission Contact'},
        {k:'corresponding_institution',l:'Corresponding Institution'},
        {k:'country_name',l:'Country'},
        {k:'versions',l:'Versions',v: d=>JSON.parse(d).map(v=>`${v.version} (${new Date(v.created).toLocaleDateString()})`).join(', ')},
        {k:'submission_type',l:'Submission Type'},
        {k:'submission_license',l:'License'},
        {k:'preprint_subject',l:'Subject'},
        {k:'published_DOI',l:'Published DOI',v: d=>`<a href="https://doi.org/${d}" target="_blank">${d}</a>`},
        {k:'publication_date',l:'Publication Date'},
        {k:'total_citation',l:'Total Citations'}
      ];
      $('metadata').innerHTML = meta.map(m=>{
        if(!data[m.k])return '';
        let val = m.v ? m.v(data[m.k]) : data[m.k];
        return `<div class="metadata-item"><span class="metadata-label">${m.l}:</span> <span class="metadata-value">${val}</span></div>`;
      }).join('');
      if(data.citation) renderCitationChart(JSON.parse(data.citation));
    });

    function renderCitationChart(citations){
      const ctx = document.createElement('canvas');
      $('citation-chart').appendChild(ctx);
      new Chart(ctx, {
        type:'bar',
        data:{
          labels:citations.map(c=>c.year),
          datasets:[{label:'Citations per year',data:citations.map(c=>c.value),backgroundColor:'rgba(54,162,235,0.7)'}]
        },
        options:{
          responsive:true,
          plugins:{legend:{display:false}},
          scales:{y:{beginAtZero:true,ticks:{precision:0}}}
        }
      });
    }
  </script>
</body>
</html>
